# 42.1 동기 처리와 비동기 처리

---

- 함수 실행 순서는 실행 컨텍스트 스택으로 관리한다.
- **🌟 자바스크립트 엔진은 단 하나의 실행 컨텍스트 스택을 갖는다.**
- 최상단의 태스크만 수행 가능하고, 나머지는 대기 중인 태스크.
- 즉 싱글 스레드이다.
- **동기** 처리, blocking 언어.
- 실행 순서 보장되지만 이후 태스크들이 블로킹되는 단점이 존재.
- setTimeout 함수는 **비동기** 함수임. 즉 다음 태스크를 곧바로 실행. → 대신 당연히 순서는 보장 안됨.
- ❗비동기 처리를 수행하는 비동기 함수는 이후 동작을 위해 콜백 패턴을 사용하지만, 이는 콜백 지옥을 일으킬 수 있음…. → 가독성 아주 저하…
- 또한 에러 처리가 곤란하며, 여러 개의 비동기 처리를 한 번에 하기도 곤란하다. → 이를 보완하기 위해 프로미스 → 이것도 보완하기 위해 async, await 가 나옴.

# 42.2 이벤트 루프와 태스크 큐

---

- 자바스크립트는 싱글 스레드 언어인지 어떻게 동시에 여러 작업이 처리되는 것 같다.
- 이런 동시성을 지원하는 것이 이벤트 루프로 브라우저에 내장되어 있다.
  ![image.png](attachment:8fff50ea-3b85-43a5-97ae-e2a738629ea5:image.png)
- V8 자바스크립트 엔진 등 **자바스크립트 엔진은 크게 2 영역**으로 구분할 수 있다.
  ### 콜 스택
  - 실행 컨텍스트 스택이다.
  - 최상위 실행 컨텍스트가 종료되어 제거되기 전까지는 다른 어떤 태스크도 실행되지 않는다.
  ### 힙
  - 객체가 저장되는 메모리 공간
  - 실행 컨텍스트에서 힙에 저장된 객체를 참조한다.
  - 메모리에 값을 저장하려면 먼저 저장할 메모리 공간의 크기를 결정하고 런타임에 동적으로 할당해야 한다.
- 자바스크립트는 위처럼 콜 스택과 힙으로만 이루어져 있어서, ❗**비동기 처리에서 소스코드의 평가와 실행을 제외한 모든 처리는 자바스크립트 엔진을 구동하는 환경인 Node.js 나 브라우저가 담당한다.**
- 비동기 동작하는 setTimeout 의 콜백 함수의 평가와 실행은 자바스크립트 엔진이 담당하지만 호출 스케줄링을 위한 타이머 설정과 콜백 함수의 등록은 브라우저가 담당. → 이를 위해 이벤트 루프와 태스크 큐 존재.
  ### 태스크 큐
  - setTimeout 이나 setInterval 과 같은 비동기 함수의 콜백 함수나 이벤트 핸들러가 일시적으로 보관되는 영역
  - 태스크 큐와는 별도로 ❗**프로미스의 후속 처리 메서드의 콜백 함수가 일시적으로 보관되는 마이크로 태스크 큐도 존재한다.**
  ### 이벤트 루프
  - 현재 콜 스택에 실행 중인 컨텍스트가 있는지 그리고 태스크 큐에 대기 중인 함수가 존재하는 지 확인하고, ❗**만약 콜 스택이 비어 있고 태스크 큐에 대기 중인 함수가 있다면 이벤트 루프는 순차적으로 태스크 큐에 대기 중인 함수를 콜 스택으로 이동시킨다. 이때 콜 스택으로 이동한 함수는 실행된다.**
  ![image.png](attachment:f23c19ae-caa2-4b92-80bc-27816b3a9914:image.png)
- 이처럼 비동기 함수인 setTimeout 콜백 함수는 태스크 큐에 푸시되어 대기하다가 콜 스택이 비게 되면, 다시 말해 전역 코드 및 명시적으로 호출된 함수가 모두 종료하면 비로소 콜 스택에 푸시되어 실행된다.
- **자바스크립트는 싱글 스레드 방식으로 동작한다. 이때 싱글 스레드 방식으로 동작하는 것은 브라우저가 아니라 브라우저에 내장된 자바스크립트 엔진이라는 것에 주의하자. → 🌟 자바스크립트 엔진은 싱글 스레드로 동작하지만 브라우저가 멀티 스레드로 동작한다.**
- ❗브라우저는 자바스크립트 엔진 외에도 렌더링 엔진과 Web API 를 제공한다. 이건 ECMAScript 사양에 정의된 함수가 아니라 브라우저에서 제공하는 API 이며, DOM API 와 타이머 함수 HTTP 요청과 같은 비동기 처리를 포함한다.
- ❗위 예제에서 살펴봣듯이 브라우저의 Web API 인 setTimeout 함수가 호출되면 자바스크립트 엔진의 콜 스택에 푸시되어 실행된다. → 하지만 타이머 설정과 타이머가 만료하면 콜백 함수를 태스크 큐에 등록하는 처리는 자바스크립트 엔진이 아니라 브라우저가 실행한다.
- 🌟 이처럼 브라우저와 자바스크립트 엔진이 협력하여 비동기 함수를 실행한다.
